# NetEdge IoT

#### 介绍
该项目是一个物联网（IoT）领域的开源解决方案，涵盖设备通信管理、业务处理及数据存储、WEB网站（包含档案管理和抄表）等核心功能，实现了设备的稳定接入、分片负载均衡、数据批量入库，以及多消息中间件的灵活使用和容灾机制。

#### 项目背景与目标
物联网领域中，海量的设备需要实现快速接入、数据稳定传输、业务高效处理以及安全可靠的数据存储。本项目通过以下手段，达成稳定、高扩展性的目标：
分片与负载均衡：将业务、存储等功能分散到多个节点，提升系统容错与扩展能力。
多消息中间件：支持多种消息中间件进行负载均衡，增强系统弹性。
本地文件队列容灾：在消息中间件失效时，确保数据不丢失。
统一配置与应用监控：通过 Redis 维护应用及设备状态，实现应用间的协同与动态调度。


#### 主要功能
1. 设备通信：
维护设备与服务器的长连接，推送在线/离线事件，处理校验及心跳包等工作。
2. 分片与负载均衡：
基于应用号进行分片（Shard ID）分配，动态调度活跃应用实例，避免集中压力。
3. 实时业务处理：
支持设备档案的加载、在线指令召读与响应。
4. 数据存盘：
数据通过分片的方式批量入库，保障同一设备仅由对应分片应用写入。
5. 多消息中间件支持：
多实例消费与发送，提高消息吞吐量及可靠性。
6. 数据不丢失容灾机制：
当消息中间件故障时，自动切换为本地文件队列进行存储，磁盘空间不足时可将最早数据文件迁移至 NAS，后续再自动拉取回来进行消费。

#### 模块说明
1. 通信模块
设备通道管理：通过 Redis 维护设备的通道状态：device_[type]_[address] -> front_end_comm_应用号。
当通道断开或长时间无通讯时，触发设备离线事件并推送给业务模块。
命令消费与发送: 按“应用号”从队列中消费下发命令（内含设备地址、数据包）。根据设备地址查找对应的网络通道并发送数据包。
设备通信校验与响应: 处理报文格式的校验和基础心跳包应答，业务无关的通用逻辑。
2. 业务模块
Restful 接口的实时召读: 通过 Nginx 负载均衡分发 API 请求，使用异步转同步机制加快响应速度（例如缓存轮询或 Future 机制等）。
3. 存盘模块
数据批量入库与缓存刷入: 保证同一设备数据由同一应用处理并写入，避免字段冲突或数据丢失。分片计算：分片号 = (设备地址 % 活跃的存盘应用数)。
线程池消费: 使用线程池来消费存盘队列，以提升数据写入性能。

#### 多消息中间件负载均衡
消息发送：可按配置顺序依次将同一条消息发送到多个中间件实例。
消息订阅与消费：多个中间件都可以同时订阅并消费消息，提升消息吞吐量。

#### 关键机制
应用号与分片管理
应用号（App ID）：
通过服务器 IP 的第四段作为应用号（例如 192.168.0.10 的应用号为 10）。
分片号（Shard ID）：
对活跃的应用号进行排序，根据顺序映射为分片号（1,2,3,4...）。
应用监控：
各模块会定时写入 Redis 中 [应用名]_heartbeat 表（Map 结构），Key=应用号, Value=当前系统时间。
“最后心跳时间 > (当前时间 - 3 * 心跳间隔)” 则判定应用处于活跃状态。


#### 心跳机制
Redis 心跳表：
通信模块写入 front_end_comm_heartbeat
业务模块写入 front_end_biz_heartbeat
存盘模块写入 front_end_data_save_heartbeat
负载均衡：
实时检查活跃模块数量、分配分片以及动态调整任务。

#### 数据不丢失保障
多重消息中间件：当一个中间件故障时，可从其他中间件继续消费消息。
本地文件队列：若所有消息中间件都无法使用，则数据写入本地文件；后续恢复后再消费。
